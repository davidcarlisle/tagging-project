
\DocumentMetadata{uncompress,testphase={latest},pdfversion=2.0,
 }

\ExplSyntaxOn
\group_begin:
\pdfdict_put:nnn {l_pdffile/Filespec} {AFRelationship}{/Supplement}
\pdffile_embed_stream:nnn{
<style>
mtable[columnalign="right ~left"] > mtr > mtd:nth-child(odd) {
padding-right:0;text-align:right;text-align:-moz-right;text-align:-webkit-right;
}
mtable[columnalign="right ~left"] > mtr > mtd:nth-child(even) {
padding-left:0;text-align:left;text-align:-moz-left;text-align:-webkit-left;
}
mtd[intent=":noequationlabel"], mtd[intent=":equationlabel"] {
margin-right: 1em;display:block; position:absolute; right:0em
}
</style>
}{latex-math-css.html}{tag/AFCSStest}
\group_end:
\ExplSyntaxOff

\tagpdfsetup{root-AF=tag/AFCSStest, math/mathml/structelem }

\documentclass[a4paper]{article}

\usepackage{unicode-math}
\usepackage{parskip}


\makeatletter
\ExplSyntaxOn
\cs_if_exist:NTF\__tag_check_typeout_v:n
 {
   \cs_set_eq:NN\__math_debug_typeout:n\__tag_check_typeout_v:n
 }
 {
   \cs_set_eq:NN\__math_debug_typeout:n\typeout
 }
\cs_set_eq:NN\__math_debug_typeout:n\typeout 
\newif\ifgather@split
\renewenvironment{split}{%
  \__math_debug_typeout:n {begin~split}
  \if@display
    \ifinner 
       \@xp\@xp\@xp\split@aligned
    \else 
      \ifst@rred \else \global\@eqnswtrue \fi
    \fi
  \else 
    \let\endsplit\@empty \@xp\collect@body\@xp\split@err
  \fi
  \collect@body\gather@split
}{\__math_debug_typeout:n{end~split}%
     \crcr
    \UseExpandableTaggingSocket{math/luamml/mtable/innertable/save}%
    \egroup
  \egroup  
  \iftagsleft@ \@xp\lendsplit@ \else \@xp\rendsplit@ \fi
}
\def\gather@split#1#2#3{
  \__math_debug_typeout:n{gather@split}%
  \@xp\endgroup \reset@equation % math@cr will handle equation numbering
  \iftag@
     \toks@\@xp{\df@tag}%
     \edef\split@tag{%
       \gdef\@nx\df@tag{\the\toks@}%
       \global\@nx\tag@true \@nx\nonumber
     }%
  \else \let\split@tag\@empty
  \fi
  \gather@splittrue
  \spread@equation
  \vcenter\bgroup
    \gather@{\split@tag
    \begin{split}#1\end{split}}%
    \def\endmathdisplay@a{%
      \__math_debug_typeout:n{endmathdisplay@a}
      \__math_debug_typeout:n{finalize~innertable~endmathdisplay@a}
      \math@cr 
      \black@ \totwidth@ 
      \egroup
      \egroup
      \ifmeasuring@\else
      \UseExpandableTaggingSocket{math/luamml/mtable/innertable/finalize}%
      \fi      
    }%
}

\def\insplit@{\__math_debug_typeout:n{insplit@}% mit gather, align
  \global\setbox\z@\vbox\bgroup
    \Let@ \chardef\dspbrk@context\@ne \restore@math@cr
    \default@tag % disallow use of \tag here
    \ialign\bgroup
      \hfil
      \strut@
      $\m@th\displaystyle {##}%
      \UseTaggingSocket{math/luamml/save/nNn}{{}\displaystyle{mtd}}%      
      $%
      \UseTaggingSocket{math/luamml/mtable/finalizecol}{last}%
      &$\m@th\displaystyle {{}##}%
      \UseTaggingSocket{math/luamml/save/nNn}{{}\displaystyle{mtd}}%      
      $%
      \UseExpandableTaggingSocket{math/luamml/mtable/finalizecol}{last}%
      \hfill % Why not \hfil?---dmj, 1994/12/28
      \crcr
}

\def\lendsplit@{%
    \global\setbox9\vtop{\unvcopy\z@}%
    \ifinalign@
        \setbox\@ne\vbox{%
            \unvcopy\z@
            \global\setbox8\lastbox
        }%
        \setbox\@ne\hbox{%
            \unhcopy8%
            \unskip
            \setbox\tw@\lastbox
            \unskip
            \global\setbox\thr@@\lastbox
        }%
        \__math_debug_typeout:n{lendsplit@/aligncase}
        \ifctagsplit@   
         \__math_debug_typeout:n{lendsplit@/aligncase/centertags}         
            \gdef\split@{%
                \hbox to\wd\thr@@{}%
               &\vcenter{\vbox{\moveleft\wd\thr@@\box9}}%
               \ifmeasuring@\else
               \__math_debug_typeout:n{finalize~innertable~aligncase}
               \UseTaggingSocket{math/luamml/mtable/innertable/finalize}%
               \fi
            }%
        \else
         \__math_debug_typeout:n{lendsplit@/aligncase/tbtags}         
            \gdef\split@{%
                \hbox to\wd\thr@@{}%
               &\vbox{\moveleft\wd\thr@@\box9}%
               \ifmeasuring@\else
               \__math_debug_typeout:n{finalize~innertable~aligncase}
               \UseTaggingSocket{math/luamml/mtable/innertable/finalize}%
               \fi  
            }%
        \fi
    \else
        \ifctagsplit@
           \ifgather@split
              \__math_debug_typeout:n{lendsplit/equationcase}
              \gdef\split@%
               {\UseTaggingSocket{math/luamml/annotate/false}{}{\vcenter{\box9}}} 
           \else
              \__math_debug_typeout:n {lendsplit/gathercase}
            \gdef\split@{\vcenter{\box9}%
              \__math_debug_typeout:n {finalize~innertable~gathercase}
              \UseTaggingSocket{math/luamml/mtable/innertable/finalize}%                        
            }
          \fi
        \else
           \ifgather@split
              \__math_debug_typeout:n {lendsplit/equationcase}
              \gdef\split@%
               {\UseTaggingSocket{math/luamml/annotate/false}{}{\box9}} 
           \else
              \__math_debug_typeout:n {lendsplit/gathercase}
              \gdef\split@{
                \box9%    
                \ifmeasuring@\else           
                \__math_debug_typeout:n {finalize~innertable~gathercase}
                \UseTaggingSocket{math/luamml/mtable/innertable/finalize}%                        
                \fi
               }
          \fi  
        \fi       
    \fi
    \aftergroup\split@
}


\def\rendsplit@{%
    \ifinalign@ 
        \global\setbox9 \vtop{%
            \unvcopy\z@
            \global\setbox8 \lastbox
            \unskip
        }%
        \setbox\@ne\hbox{%
            \unhcopy8
            \unskip
            \global\setbox\tw@\lastbox
            \unskip
            \global\setbox\thr@@\lastbox
        }%
        \ifctagsplit@ 
            \gdef\split@{%
                \hbox to\wd\thr@@{}
                &\vcenter{\vbox{\moveleft\wd\thr@@\boxz@}}%
            \__math_debug_typeout:n {rendsplit/aligncase}    
            \ifmeasuring@\else    
            \__math_debug_typeout:n {finalize~innertable~aligncase}             
            \UseTaggingSocket{math/luamml/mtable/innertable/finalize}  
            \fi 
            }%
        \else 
           \__math_debug_typeout:n{lendsplit@/aligncase/tbtags}
        %TODO tbtags is not correct yet
            \global\setbox7 \hbox{\unhbox\tw@\unskip}%
            \gdef\split@{%
                \global\@tempcnta\column@
               &\setboxz@h{}%
                \savetaglength@
                \global\advance\row@\@ne
                \vbox{\moveleft\wd\thr@@\box9}%
               \crcr
                \noalign{\global\lineht@\z@}%
                \add@amps\@tempcnta
                \UseTaggingSocket{math/luamml/annotate/false}{}{\box\thr@@}                
               &\box7
                \ifmeasuring@\else 
                 \__math_debug_typeout:n {finalize~innertable~aligncase}
                 \UseTaggingSocket{math/luamml/mtable/innertable/finalize}%                        
                \fi
            }%
        \fi
    \else 
        \ifctagsplit@ 
            \ifgather@split
              \__math_debug_typeout:n {rendsplit/equationcase}
              \gdef\split@%
               {\UseTaggingSocket{math/luamml/annotate/false}{}{\vcenter{\boxz@}}} 
            \else
              \__math_debug_typeout:n  {rendsplit/gathercase}
              \gdef\split@{\vcenter{\boxz@}%
              \ifmeasuring@\else 
               \__math_debug_typeout:n {finalize~innertable~gathercase}
               \UseTaggingSocket{math/luamml/mtable/innertable/finalize}%                        
              \fi
              }
            \fi  %
        \else
            \gdef\split@{%
                \boxz@
            }%
        \fi
    \fi
    \aftergroup\split@
}
\ExplSyntaxOff

\usepackage{unicode-math}

\title{Aligned equations}
\author{\LaTeX\ Team}
\date{February 2025}

\addtolength\textheight{6cm}
\addtolength\topmargin{-4cm}
\begin{document}

\maketitle



Simple \texttt{align}
\begin{align}
  a+b&=x^2+x+2\\
    b&=x
\end{align}



Simple \texttt{align*}
\begin{align*}
  c+d&=x^2+x+2\\
    d&=x
\end{align*}


\texttt{aligned} in \texttt{equation}
\begin{equation}
\begin{aligned}
  e+f&=x^2+x+2\\
    f&=x
\end{aligned}
\end{equation}

\texttt{split} in \texttt{align}
\begin{align}
\begin{split}
  x&= a  +  b\\
   &\quad + c
\end{split}\\
  y&=d\\
\end{align}

\texttt{split} in \texttt{equation}
\begin{equation}
\begin{split}
 a & = b+b\\
   &\quad + c
\end{split} 
\end{equation}

\texttt{split} in \texttt{[}
\[
\begin{split}
 a & = b-b\\
   &\quad + c
\end{split} 
  \]

\texttt{split} in \texttt{gather} 
\begin{gather}
\begin{split}
 a & = b\times b\\
   &\quad + c
\end{split}\\
x=1
\end{gather}


\end{document}

